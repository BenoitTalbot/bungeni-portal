Bill Workflow
=============

The default bill workflow models the Westminister Tradition.

Setup
-----

  >>> from bungeni.core.domain import Bill
  >>> from bungeni.core.workflows.bill import states
  >>> import bungeni.core.interfaces
  >>> from ore.workflow.interfaces import IWorkflow, IWorkflowInfo
  >>> import ore.workflow
  >>> from ore.alchemist import Session  
  >>> import copy  
  

  
  >>> import bungeni.core as model
  >>> import datetime
  
  some setup for tests

   >>> from zope import component
   >>> from sqlalchemy import create_engine
   >>> from ore.alchemist.interfaces import IDatabaseEngine
   >>> from bungeni import core as model
   >>> from bungeni.core import domain, schema
   
Setting up Database Connection and Utilities:

   >>> db = create_engine('postgres://localhost/bungeni-test', echo=False)
   >>> component.provideUtility( db, IDatabaseEngine, 'bungeni-db' )
   >>> model.metadata.bind = db   
   >>> model.metadata.create_all()
   >>> from alchemist.security.schema import metadata  
   >>> metadata.bind = db
   >>> metadata.create_all()  
   >>> session = Session()
   >>> i = 0  
  
  >>> component.provideAdapter(
  ...    bungeni.core.workflows.WorkflowState,
  ...    (bungeni.core.interfaces.IBungeniContent,))

  >>> component.provideAdapter(
  ...    bungeni.core.workflows.bill.BillWorkflowAdapter,
  ...    (Bill,))

  >>> component.provideAdapter(
  ...    ore.workflow.workflow.WorkflowInfo,
  ...    (Bill,))
  
  >>> def transitions(content):
  ...     wf = IWorkflow(content)
  ...     return tuple(transition.transition_id for transition in wf.getTransitions( content.status ) )



Security Adapters
-----------------

  >>> import alchemist.security.permission
  >>> import alchemist.security.role

  
  >>> component.provideAdapter(
  ...    alchemist.security.role.GlobalPrincipalRoleMap,
  ...    (bungeni.core.interfaces.IBungeniContent,))

  >>> component.provideAdapter(
  ...    alchemist.security.permission.GlobalRolePermissionMap,
  ...    (bungeni.core.interfaces.IBungeniContent,))

  >>> component.provideAdapter(
  ...    alchemist.security.role.LocalPrincipalRoleMap,
  ...    (bungeni.core.interfaces.IBungeniContent,))

  >>> component.provideAdapter(
  ...    alchemist.security.permission.LocalRolePermissionMap,
  ...    (bungeni.core.interfaces.IBungeniContent,))

  >>> import bungeni.core.version
  >>> component.provideAdapter(
  ...    bungeni.core.version.ContextVersioned,
  ...    (bungeni.core.interfaces.IVersionable,),
  ...    bungeni.core.interfaces.IVersioned)

Transition events
-----------------

We set up event subscribers to make sure all registered transition
events are called.

#XXX
  
Permissions
-----------
  >>> def permission(bill):
  ...   wf = IWorkflow(bill)
  ...   info = IWorkflowInfo(bill)
  ...   state = info.state().getState()
  ...   return tuple(transition.permission for transition in wf.getTransitions(state))
    
Schedule a bill
-------------------
  >>> def schedule_bill(bill_id):
  ...   item_schedule = domain.ItemSchedule()
  ...   item_schedule.sitting_id = sit1.sitting_id
  ...   item_schedule.item_id = bill.bill_id
  ...   session.save(item_schedule)
  ...   session.flush()   

Sitting to schedule the bill:
-----------------------------
  >>> st = model.SittingType()
  >>> st.sitting_type = u"morning"
  >>> st.start_time = datetime.time(8,30)
  >>> st.end_time = datetime.time(12,30)  
  >>> session.save(st)
  >>> session.flush()

  >>> st.sitting_type_id
  1L
 
  >>> sit1 = model.GroupSitting()
  >>> sit1.start_date = datetime.datetime.now()
  >>> sit1.end_date = datetime.datetime.now()
  >>> sit1.sitting_type = st.sitting_type_id
  >>> session.save(sit1)
  >>> session.flush() 
  
Owner of the bill
-----------------
  >>> country = model.Country()
  >>> country.country_id = 'KE'
  >>> country.country_name = u"Kenya"
  >>> session.save(country)
  >>> session.flush()
 
  >>> mp_1 = model.ParliamentMember(u"mp_1", 
  ...        first_name=u"a", 
  ...        last_name=u'ab', 
  ...        birth_country="KE",
  ...        email=u"mp1@example.com", 
  ...        date_of_birth=datetime.datetime.now(),
  ...        gender='M') 
  
  >>> session.save(mp_1)
  >>> session.flush()

Bill Types
----------
  >>> bt = model.BillType()
  >>> bt.bill_type_name = u"Private Bill"
  >>> session.save(bt)
  >>> session.flush()


  >>> bill = Bill()
  >>> bill.bill_type_id = bt.bill_type_id
  >>> bill.owner_id = mp_1.user_id
  >>> bill.title = u"New Bill"
  >>> session.save(bill)
  >>> session.flush()



Drafting A Bill
---------------
  
  >>> transitions( bill )
  (u'create-bill',)
    
  >>> bill.workflow.fireTransition('create-bill')  

  >>> transitions( bill )
   (u'submit-bill',)
   
Publish Bill in gazette
-----------------------
  >>> bill.workflow.fireTransition('submit-bill')  
  >>> transitions( bill )
  (u'withdraw-submitted', u'schedule-first')
  
A Bill can be withdrawn at (almost) any stage:
----------------------------------------------
  >>> bill_withdraw = copy.deepcopy(bill)     
  >>> result = IWorkflowInfo(bill_withdraw).fireTransition('withdraw-submitted')     
  >>> bill_withdraw.status  
  u'bill withdrawn'
  >>> transitions( bill_withdraw ) 
  ()
  
  
First Reading
-------------
First step for a bill is to be scheduled for a public reading, the user interface
presents a transition specific ui viewlet to be used for scheduling the reading.

  >>> schedule_bill(bill.bill_id)
  >>> bill.workflow.fireTransition('schedule-first')    
  >>> transitions( bill )
  (u'postpone-first', u'ma-schedule-second', u'withdraw-first-reading', u'select-first-committee')
  
The first reading can be postponed:

  >>> bill.workflow.fireTransition('postpone-first')    
  >>> transitions( bill )
  (u'reschedule-first',) 

and rescheduled:
  >>> bill.workflow.fireTransition('reschedule-first')    
  >>> transitions( bill )
  (u'postpone-first', u'ma-schedule-second', u'withdraw-first-reading', u'select-first-committee')


A Bill can be withdrawn at (almost) any stage:
----------------------------------------------
  >>> bill_withdraw = copy.deepcopy(bill)     
  >>> result = IWorkflowInfo(bill_withdraw).fireTransition('withdraw-first-reading')     
  >>> bill_withdraw.status  
  u'bill withdrawn'
  >>> transitions( bill_withdraw ) 
  ()


Committees
----------

Next step, optionally is to send the bill to a committee. After a bill is 
sent to committee, it can be scheduled for a second reading
  
  >>> bill_1st_committee = copy.deepcopy(bill)     
  >>> result = IWorkflowInfo(bill_1st_committee).fireTransition('select-first-committee')     
  >>> bill_1st_committee.status  
  u'first committee'
  >>> transitions( bill_1st_committee ) 
  (u'withdraw-first-committee', u'schedule-second-from-first-committee')
  
A Bill can be withdrawn at (almost) any stage:
----------------------------------------------
  >>> bill_withdraw = copy.deepcopy(bill_1st_committee)     
  >>> result = IWorkflowInfo(bill_withdraw).fireTransition('withdraw-first-committee')     
  >>> bill_withdraw.status  
  u'bill withdrawn'
  >>> transitions( bill_withdraw ) 
  ()

or made avaliable for scheduling for the 2nd committee
------------------------------------------------------
  >>> result = IWorkflowInfo(bill_1st_committee).fireTransition('schedule-second-from-first-committee')     
  >>> bill_1st_committee.status  
  u'second reading pending'
  >>> transitions( bill_1st_committee ) 
  (u'schedule-second',)


Second Reading
--------------
We can then schedule a second reading, again in the ui, this presents a workflow
viewlet for scheduling the bill.
 
The Bill can be made available for scheduling from the 1st reading

  >>> bill.workflow.fireTransition('ma-schedule-second')    
  >>> transitions( bill ) 
  (u'schedule-second',) 

and finally scheduled for the second reading

  >>> bill.workflow.fireTransition('schedule-second')    
  >>> transitions( bill ) 
  (u'ma-schedule-whole-house', u'withdraw-second-reading', u'postpone-second')

A Bill can be withdrawn at (almost) any stage:
----------------------------------------------
  >>> bill_withdraw = copy.deepcopy(bill)     
  >>> result = IWorkflowInfo(bill_withdraw).fireTransition('withdraw-second-reading')     
  >>> bill_withdraw.status  
  u'bill withdrawn'
  >>> transitions( bill_withdraw ) 
  ()

The second reading can be postponed:

  >>> bill.workflow.fireTransition('postpone-second')    
  >>> transitions( bill ) 
  (u'reschedule-second',)

and rescheduled:
  >>> bill.workflow.fireTransition('reschedule-second')    
  >>> transitions( bill ) 
  (u'ma-schedule-whole-house', u'withdraw-second-reading', u'postpone-second')


Committee of the Whole House
----------------------------
make the bill available for scheduling:
 
  >>> bill.workflow.fireTransition('ma-schedule-whole-house')    
  >>> transitions( bill ) 
  (u'schedule-whole-house',)

and schedule it:

  >>> bill.workflow.fireTransition('schedule-whole-house')    
  >>> transitions( bill ) 
   (u'select-second-committee', u'withdraw-whole-house', u'ma-schedule-third-reading', u'postpone-second-reading-and-whole-house', u'postpone-whole-house')

A Bill can be withdrawn at (almost) any stage:
----------------------------------------------
  >>> bill_withdraw = copy.deepcopy(bill)     
  >>> result = IWorkflowInfo(bill_withdraw).fireTransition('withdraw-whole-house')     
  >>> bill_withdraw.status  
  u'bill withdrawn'
  >>> transitions( bill_withdraw ) 
  ()

postpone whole house

  >>> bill.workflow.fireTransition('postpone-whole-house')    
  >>> transitions( bill ) 
  (u'reschedule-whole-house',)

and reschedule whole house

  >>> bill.workflow.fireTransition('reschedule-whole-house')    
  >>> transitions( bill ) 
   (u'select-second-committee', u'withdraw-whole-house', u'ma-schedule-third-reading', u'postpone-second-reading-and-whole-house', u'postpone-whole-house')

if the second reading and the committee of the whole house did not take place
you can postpone both:

  >>> bill_whp2 = copy.deepcopy(bill)     
  >>> result = IWorkflowInfo(bill_whp2).fireTransition('postpone-second-reading-and-whole-house')     
  >>> transitions(bill_whp2)
  (u'reschedule-second',)


Third Reading
-------------
from the second reading the third reading can be scheduled directly:

  >>> bill_tr = copy.deepcopy(bill)     
  >>> result = IWorkflowInfo(bill_tr).fireTransition('ma-schedule-third-reading')     
  >>> transitions(bill_tr)
  (u'second-committee-schedule-third-reading',)

or it can be send to a second committee first.
Second Committee:
-----------------

  >>> bill.workflow.fireTransition('select-second-committee')    
  >>> transitions( bill ) 
  (u'withdraw-second-committee', u'ma-schedule-second-report-reading')

A Bill can be withdrawn at (almost) any stage:
----------------------------------------------
  >>> bill_withdraw = copy.deepcopy(bill)     
  >>> result = IWorkflowInfo(bill_withdraw).fireTransition('withdraw-second-committee')     
  >>> bill_withdraw.status  
  u'bill withdrawn'
  >>> transitions( bill_withdraw ) 
  ()

The report of the 2nd committee is to be read:
---------------------------------------------
make available for scheduling 

  >>> bill.workflow.fireTransition('ma-schedule-second-report-reading')    
  >>> transitions( bill ) 
  (u'schedule-second-report-reading',)
  
and schedule:

  >>> bill.workflow.fireTransition('schedule-second-report-reading')    
  >>> transitions( bill ) 
  (u'ma-second-committee-schedule-third-reading', u'postpone-second-report-reading', u'recommit-second-committee', u'withdraw-report-reading')

A Bill can be withdrawn at (almost) any stage:
----------------------------------------------
  >>> bill_withdraw = copy.deepcopy(bill)     
  >>> result = IWorkflowInfo(bill_withdraw).fireTransition('withdraw-report-reading')     
  >>> bill_withdraw.status  
  u'bill withdrawn'
  >>> transitions( bill_withdraw ) 
  ()

The report reading can be postponed:

  >>> bill.workflow.fireTransition('postpone-second-report-reading')    
  >>> transitions( bill ) 
  (u'reschedule-second-report-reading',)
  
and rescheduled:

  >>> bill.workflow.fireTransition('reschedule-second-report-reading')    
  >>> transitions( bill ) 
  (u'ma-second-committee-schedule-third-reading', u'postpone-second-report-reading', u'recommit-second-committee', u'withdraw-report-reading')
  

After the reading the bill can be send back to the committee:

  >>> bill_2ndc = copy.deepcopy(bill)     
  >>> result = IWorkflowInfo(bill_2ndc).fireTransition('recommit-second-committee') 
  >>> transitions( bill_2ndc )   
  (u'withdraw-second-committee', u'ma-schedule-second-report-reading')
  
or made available for the 3rd reading:  
  >>> bill.workflow.fireTransition(u'ma-second-committee-schedule-third-reading')    
  >>> transitions( bill )   
  (u'second-committee-schedule-third-reading',)
  
Third Reading:
--------------
schedule it for the third reading:

  >>> bill.workflow.fireTransition('second-committee-schedule-third-reading')    
  >>> transitions( bill )   
  (u'withdraw-third-reading', u'reject', u'approve', u'postpone-third-reading')

A Bill can be withdrawn at (almost) any stage:
----------------------------------------------
  >>> bill_withdraw = copy.deepcopy(bill)     
  >>> result = IWorkflowInfo(bill_withdraw).fireTransition('withdraw-third-reading')     
  >>> bill_withdraw.status  
  u'bill withdrawn'
  >>> transitions( bill_withdraw ) 
  ()

the third reading can be postponed:

  >>> bill.workflow.fireTransition('postpone-third-reading')    
  >>> transitions( bill )   
  (u'reschedule-third-reading',)

and rescheduled:
  >>> bill.workflow.fireTransition('reschedule-third-reading')    
  >>> transitions( bill )   
  (u'withdraw-third-reading', u'reject', u'approve', u'postpone-third-reading')

  
Vote - Approved/Rejected
------------------------
either the bill gets approved:
  >>> bill_approve = copy.deepcopy(bill) 
  >>> bill_approve.workflow.fireTransition('approve') 
  >>> transitions( bill_approve ) 
  ()
    
or rejected:
  >>> bill.workflow.fireTransition('reject')    
  >>> transitions( bill ) 
  ()
  
  
cleanup
-------
  >>> session.flush()
  >>> session.commit()
  >>> session.close()
  
