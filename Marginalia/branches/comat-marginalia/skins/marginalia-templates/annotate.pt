<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="plone">

<metal:block fill-slot="javascript_head_slot"
	tal:define="absoluteUrl string:${here/absolute_url};
	annotatedUrl python:view.getAnnotatedUrl(absoluteUrl);
    isadmin python:context.portal_annotations.isAdmin(context);
    ">

    <script type="text/javascript" src="" tal:attributes="src string:${context/absolute_url}/referencebrowser.js"></script>

    <script type="text/javascript" tal:content="string:
        function load() {
            var search_button = document.getElementById('search');
            filterAnnotations(search_button);
        }

        function show_annotations_on_load() 
        {
			var serviceRoot = '${request/base}/${utool/getPortalPath}/portal_annotations';
			var username = '${user/getUserName}';
            var isadmin = '${isadmin}';
            var superuser = false;
            if (isadmin == 'True'){
            superuser = true;
            }
			var url = '${annotatedUrl}';
            var restService = '/annotate';
	        bungeniMarginaliaInit( username, superuser, url, serviceRoot, restService );
            setTimeout( 'load();', 500);    
		}
        function addLoadEvent(func) {
          var oldonload = window.onload;
          if (typeof window.onload != 'function') {
            window.onload = func;
          } else {
          window.onload = function() {
            if (oldonload) {
               oldonload();
            }
            func();
            }
          }
        }

        addLoadEvent(show_annotations_on_load);

		/*
		 * Called when the margin button is clicked to create an annotation.
		 * There are two choices for editor:
		 * 1. SelectAnnotationNoteEditor - select an edit action
		 * 2. BungeniNoteEditor - create a simple margin note
		 */
		function bungeniClickCreateAnnotation( event, id )
		{
           var button = document.getElementById('clear');
           flag = myAnnotations(button);
           if (flag!=true) {
           alert( getLocalized( 'add settings' ) );
               return false
           }
		   clickCreateAnnotation(event, id, false);
		}
		">
    </script>
<style type="text/css">
.hentry .notes li button.annotation-link {
    background-image:url(link.gif);
}
</style>
<tal:con tal:condition="isadmin">
<style type="text/css">
.hentry em.annotation {
   background: none;
}

.hentry em.annotation em.annotation {
   background: none;     
}

.hentry em.annotation em.annotation em.annotation {
   background: none;
}

.hentry em.annotation em.annotation em.annotation em.annotation {
   background: none;
}

.hentry em.annotation em.annotation em.annotation em.annotation em.annotation {
   background: none;
}

.hentry .entry-content em.annotation ins {
   color:black;
}

.hentry .entry-content em.annotation del {
   display:none;     
}

</style>
</tal:con>
</metal:block>

<body>

<metal:main fill-slot="main"
	tal:define="absoluteUrl string:${here/absolute_url};
	annotatedUrl python:view.getAnnotatedUrl(absoluteUrl);
    isadmin python:context.portal_annotations.isAdmin(context);">

    <tal:main-macro metal:define-macro="main"
           tal:define="text python: here.CookedBody(stx_level=2)">

        <div metal:use-macro="here/document_actions/macros/document_actions">
            Document actions (print, sendto etc)
        </div>

                    <div class="searchfields" tal:define="member_names python:context.portal_annotations.getOwnerList(request);
                                                   group_names python:context.portal_annotations.getPortalGroups();">
                      <a href="javascript:toggle_visibility('fields');"><p class="plink" i18n:translate="filter-help">Filter comments by owner, group or query string. (show/hide)</p></a>
                      <p class="plink" i18n:translate="search-text">Search text can include wildcard chartecters like '?' and '*'</p>
                      <a id="togglevisibility" name="hide" href="javascript:hideAnnotations(this);"><p class="plink" i18n:translate="toggle-text">Toggle hide/display comments</p></a>
                      <p id="noresults" class="plink" style="display:none;" i18n:translate="search-results">No Comments Found</p>

		            <div id="fields" style="display:block;">
                      <select class="select_field" name="filter_owner" size="4" multiple="multiple" language="javascript" onChange="filterAnnotations(this);">
                        <tal:se tal:condition="isadmin">
                         <option value="" tal:attributes="value user/getUserName">Myself</option>
                         <option value="select_all" selected="selected">All</option>
                        </tal:se> 
                        <tal:se tal:condition="not: isadmin">
                         <option value="" tal:attributes="value user/getUserName" selected="selected">Myself</option>
                         <option value="select_all">All</option>
                        </tal:se> 
                         <optgroup LABEL="Filter by User ">
                         <span tal:repeat="name member_names" tal:omit-tag="">
                            <span tal:condition="python:name!=user.getUserName()" tal:omit-tag="">
                            <option value="" tal:attributes="value name" tal:content="name">Second</option>
                            </span>
                         </span>
                         </optgroup> 
                      </select>
                      <select class="select_field" name="filter_group" size="4" multiple="multiple" language="javascript" onChange="filterAnnotations(this);">
                         <option value="select_all" selected="selected">All</option>
                         <optgroup LABEL="Filter by Group ">
                           <span tal:repeat="group group_names" tal:omit-tag="">
                         <option value="" tal:attributes="value python:group[0]" tal:content="python:group[1]">Managers</option>
                         </span>
                         </optgroup> 
                      </select>
                      <input class="input_field" type="text" name="annotation_search" value="" onChange="filterAnnotations(this);" onkeypress="return onEnterKey(this, event);"/>
                      <input class="input_field" type="button" id="search" value="Search" onClick="filterAnnotations(this);" />        
                      <input class="input_field" type="button" id="clear" value="Clear Search" onClick="clearSearch(this);" />        
         		      <span id="loader" style="display:none;">
                       <img title="Loader" alt="" src="loader.gif" />
                      </span>

                      </div>
                    </div>

<div class="marginalia-usage" i18n:translate="marginalia-usage">To add a comment, hightlight the text in the document and then click on the blue
bar.</div>

        <h3 tal:content="object_title" class="documentFirstHeading">
          Title or id
        </h3>

        <!-- Marginalia .. -->
        <ul id="debug" style="display:none">
            <li></li>
        </ul>
    
<div class="visualClear"><!-- --></div>
    
        <div class="stx"
             tal:condition="text"
             tal:attributes="class python:here.Format() in ('text/structured', 'text/x-rst', ) and 'stx' or 'plain'">
            <div class="hentry" id="m1">
              <table style="width: 100%">
                <tr>
					<td>
						<div id="markers" class="markers"></div>
					</td>
                  <td>
                    <div class="entry-content" tal:content="structure text" />
                    <a rel="bookmark" tal:attributes="href annotatedUrl"
                        href="http://www.geof.net/code/annotation/demo/#m1">#</a>
                  </td>
                  <td>
                    <div class="notes">
                      <button i18n:translate="menu-bar" class="createAnnotation" onclick="bungeniClickCreateAnnotation(event,'m1')" title="Click here to create an annotation">M e n u &nbsp; B a r</button>
                      <ol><li></li></ol>
                    </div>
                  </td>
                </tr>
              </table>
            </div>
        </div>

        <div metal:use-macro="here/document_relateditems/macros/relatedItems">
            show related items if they exist
        </div>
    
    </tal:main-macro>
</metal:main>

</body>
</html>

